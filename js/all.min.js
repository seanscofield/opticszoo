var k,aa,ba;function ca(){var a=document.getElementById("helpModal"),t=document.getElementsByClassName("close")[0];document.getElementById("help").onclick=function(){a.style.display="block"},t.onclick=function(){a.style.display="none"},window.onclick=function(t){t.target==a&&(a.style.display="none")}}function da(){document.getElementById("share").onclick=function(){var t=window.location.href.split("?")[0]+"?cs="+ea();navigator.clipboard.writeText(t),setTimeout(function(){alert("Copied project URL to clipboard!")},300)}}function fa(){ca(),da(),helpIcon=document.getElementById("help"),aa=document.getElementById("redo"),ba=document.getElementById("undo"),(fileInput=document.getElementById("fileInput")).addEventListener("change",function(t){t=t.target.files[0];var a=new FileReader;a.readAsText(t),a.onload=function(){var t=ga(a.result);p.load(t)},a.onerror=function(){alert(a.error)}}),ba.addEventListener("click",function(){ha()}),aa.addEventListener("click",function(){ia()})}function q(t,a){this.ma=t,this.ca=a}function ja(t){return[t.ma*Math.cos(t.ca),t.ma*Math.sin(t.ca)]}function ka(t){return new q(t.ma,t.ca+Math.PI)}function la(t,a,e,i){e/=i;var n=(i=t.ma*a.ma*Math.cos(a.ca-t.ca))<0?-1:1;return t=ja(new q(t.ma*e,t.ca)),e=ja(new q(a.ma*n*(Math.sqrt(1-Math.pow(e,2)*(1-Math.pow(i,2)))-n*e*i),a.ca)),a=t[0]+e[0],t=t[1]+e[1],new q(Math.sqrt(a*a+t*t),Math.atan2(t,a)).normalize()}function ma(a,e,i,n,s,o,h,r,l){var c=[],d=[a,e];return a=[i-a,n-e],e=[h*Math.cos(r)+s,h*Math.sin(r)+o],r=[h*Math.cos(r+l)+s,h*Math.sin(r+l)+o],s=t(d,u([s,o],-1)),0==(h=Math.pow(x(a,s),2)-x(a,a)*(x(s,s)-h*h))?z(e,r,d,a,-1*x(a,s)/x(a,a),c):0<h&&(o=(-1*x(a,s)-Math.sqrt(h))/x(a,a),z(e,r,d,a,(-1*x(a,s)+Math.sqrt(h))/x(a,a),c),z(e,r,d,a,o,c)),c}function z(a,e,i,n,s,o){i=t(i,u(n,s)),n=t(i,u(a,-1));var h=t(e,u(a,-1));n=n[0]*h[1]-h[0]*n[1],(a=(0!=t(e,u(a,-1))[0]||0!=t(e,u(a,-1))[1])&&0<=n)&&0<=s&&s<=1&&o.push(i)}function t(t,a){if(t.length==a.length)for(var e=Array(t.length),i=e.length-1;0<=i;i--)e[i]=t[i]+a[i];else e=!1;return e}function u(t,a){for(var e=Array(t.length),i=e.length-1;0<=i;i--)e[i]=a*t[i];return e}function x(t,a){if(t.length==a.length)for(var e=0,i=t.length-1;0<=i;i--)e+=t[i]*a[i];return e}function A(t,a,e,i){return Math.sqrt((t-e)*(t-e)+(a-i)*(a-i))}function na(t,a){a.forEach(function(t){this.push(t)},t)}function C(t,a){return(t%a+a)%a}function D(t,a,e){return null==e&&(e=.001),Math.abs(t-a)<e}function oa(t,a,e,i,n,s,o,h){var r,l,c,u={x:null,y:null},d=(h-s)*(e-t)-(o-n)*(i-a);return 0!=d&&(c=(e-t)*(r=a-s)-(i-a)*(l=t-n),r=((o-n)*r-(h-s)*l)/d,l=c/d,u.x=t+r*(e-t),u.y=a+r*(i-a),0<=r&&r<=1&&0<=l&&l<=1&&u)}function pa(t,a,e){this.x=t,this.y=a,this.Ra=e,this.Oa=30,this.color="#ace600",this.reset()}function qa(t){for(var a,e=t.aa,i=t.ba,n=t.aa+Number.MAX_SAFE_INTEGER*Math.cos(t.ca),s=t.ba+Number.MAX_SAFE_INTEGER*Math.sin(t.ca),o=p.ia,h=0;h<4;h+=1)if((a=oa(e,i,n,s,(a=o[h]).aa,a.ba,a.pa,a.qa))&&(!D(a.x,e,.001)||!D(a.y,i,.001))){t.pa=Math.round(a.x),t.qa=Math.round(a.y);break}}function ra(t){var a=t.path,e=a.length;for(ctx.strokeStyle=t.color,ctx.lineWidth=sa/E,ctx.beginPath(),ctx.moveTo(t.path[0][0],t.path[0][1]),t=1;t<e;t+=1)ctx.lineTo(a[t][0],a[t][1]);ctx.stroke()}function G(t,a,e,i,n){this.x=t,this.y=a,this.xa=e,this.rotation=i,this.ya=n,this.attributes=["x","y","h","rotation","numRays"],this.type="lightSource",ta(this)}function ta(t){t.Ga=[];for(var a=t.xa/t.ya,e=0;e<t.ya;e+=1)t.Ga.push(new pa(t.x-e*a*Math.sin(t.rotation),t.y-t.xa/2+e*a*Math.cos(t.rotation),t.rotation))}function ua(t){var a=t.xa,e=t.x+a/2*Math.sin(t.rotation),i=t.y+a/2*Math.cos(t.rotation),n=e-a/2*Math.cos(t.rotation),s=i-a/4*Math.cos(t.rotation),o=n-3*a/5*Math.cos(t.rotation),h=s-a/2*Math.sin(t.rotation),r=o-4*a/5*Math.sin(t.rotation),l=h-6*a/11*Math.cos(t.rotation),a=l-a/6,c=[];c.push(new I(e,i,n,s)),c.push(new I(n,s,o,h)),c.push(new I(o,h,r,l)),c.push(new I(r,l,n,l)),c.push(new I(n,l,e,a)),c.push(new I(e,a,e,i)),t.ia=c}q.prototype.normalize=function(){return new q(1,this.ca)},pa.prototype.reset=function(){this.aa=this.x,this.ba=this.y,this.ca=this.Ra,this.path=[[this.aa,this.ba]],this.n=1,qa(this)},(k=G.prototype).Aa=function(t,a){this[t]=a,p.valid=!1,H.display()},k.getAttribute=function(t){return"x"==t?this.x:"y"==t?this.y:"rotation"==t?this.rotation:"h"==t?this.xa:"numRays"==t?this.ya:void 0},k.Ha=function(t,a){ta(this);for(var e=this.Ga.length,i=0;i<e;i+=1)t:{var n=this.Ga[i],s=t,o=a,h=void 0,r=void 0,l=n.Oa;n.reset();for(var c=0;c<l;c+=1){for(var u=n,d=s,h=u.aa,f=u.ba,y=void 0,r=[],m=d.length,v=0;v<m;v+=1)!(y=d[v].Ba(u))||D(y.x,h,.01)&&D(y.y,f,.01)||r.push(y);if(0<r.length){for(d=u=void 0,m=A((y=r[0]).x,y.y,h,f),v=0;v<r.length;v+=1)(u=A((d=r[v]).x,d.y,h,f))<m&&(y=d,m=u);h=y}else h=!1;if(!h)break;if(n.path.push([h.x,h.y]),r=h.curve,h.element.n<0){ra(n);break t}f=new q(1,n.ca),r=h.element.sa(r,h.x,h.y),v=f.ma*r.ma*Math.cos(r.ca-f.ca)<0?h.element.n:1,u=la(f,r,n.n,v),isNaN(u.ca)?u=ka(la(f,r,v=n.n,-1*v)):n.n=v,n.ca=C(u.ca,2*Math.PI),n.aa=h.x,n.ba=h.y,qa(n)}if(c<l)for(c=0;c<4;c+=1)if((h=o[c].Ba(n))&&(!D(h.x,n.aa,.01)||!D(h.y,n.ba,.01))){n.path.push([h.x,h.y]);break}ra(n)}this.ja(p.da)},k.ja=function(t){ua(this);var a=this.ia;path=this.path=new Path2D,t.fillStyle="#996633",t.beginPath(),path.moveTo(a[0].aa,a[0].ba);for(var e=a.length,i=0;i<e;i+=1)a[i].ja(path);t.closePath(),t.drawImage(va,this.x-85,this.y-44,85,85)},k.Ia=function(t){ua(this);var a=this.ia;path=this.path=new Path2D,t.beginPath(),t.strokeStyle="#ffcc00",t.lineWidth=2,path.moveTo(a[0].aa,a[0].ba);for(var e=a.length,i=0;i<e;i+=1)a[i].ja(path);t.closePath(),t.drawImage(J,this.x-85,this.y-44,85,85)},k.contains=function(t,a){return p.da.isPointInPath(this.path,t,a)};var Aa,wa=!(k.Ea=function(){return new G(this.x,this.y,this.xa,this.rotation,this.ya)}),xa=!1,E=1,K=0,L=0,ya=0,za=0;function Ba(t,a,e){var i;(e=Math.round(50*e)/50)>p.Qa&&e<p.Pa&&(i=E-e,E=e,K=t=K+t*i,L=a=L+a*i,p.da.setTransform(E,0,0,E,K,L))}function M(t){this.canvas=t,this.width=t.width,this.canvas.height-=15,this.height=t.height,this.canvas.style["background-color"]="#1a1a1a",Ca(this),Da(this),Aa=document.getElementById("banner").getBoundingClientRect().height,this.Ka=0,this.Qa=this.height/8e3/100,this.Pa=this.height/8e3*200,this.da=t.getContext("2d"),document.defaultView&&document.defaultView.getComputedStyle&&(this.Ua=parseInt(document.defaultView.getComputedStyle(t,null).paddingLeft,10)||0,this.Va=parseInt(document.defaultView.getComputedStyle(t,null).paddingTop,10)||0,this.Sa=parseInt(document.defaultView.getComputedStyle(t,null).borderLeftWidth,10)||0,this.Ta=parseInt(document.defaultView.getComputedStyle(t,null).borderTopWidth,10)||0);var a=document.body.parentNode,s=(this.Na=a.offsetTop,this.Ma=a.offsetLeft,this.valid=!1,this.ka=[],this.za=this.wa=!1,this.selection=null,this.la=this.ra=0,this);t.addEventListener("selectstart",function(t){return t.preventDefault(),!1},!1),t.addEventListener("mousedown",function(t){t=(e=N(s,t)).x;var a=e.y,e=Ea(t,a);if("planoconvex"==O)t=new P(e.x,e.y,0,1.5,3e4,-100,50,40,"#33cccc"),Q(p,t),O="default";else if("planoconcave"==O)t=new P(e.x,e.y,0,1.5,3e4,100,50,20,"#33cccc"),Q(s,t),O="default";else if("medium"==O)t=new P(e.x,e.y,0,1.5,3e4,3e4,60,120,"#33cccc"),Q(s,t),O="default";else if("lightSource"==O){var i=new G(e.x,e.y,80,0,15);R(p),(t=p).ea=i,t.valid=!1,O="default"}else if("mirror"==O)t=new P(e.x,e.y,0,0,3e4,3e4,70,15,"#cccccc"),Q(p,t),O="default";else if("wall"==O)t=new P(e.x,e.y,0,-1,3e4,3e4,70,15,"#996633"),Q(p,t),O="default";else if(S)s.ra=t,s.la=a,s.za=!0;else if(T)s.ra=t,s.la=a,s.Fa=!0;else if(s.ea&&s.ea.contains(t,a))t=s.ea,U?(s.La=Math.atan2(e.y-t.y,e.x-t.x),s.Ca=!0):(s.ra=e.x-t.x,s.la=e.y-t.y,s.wa=!0),s.selection=t,s.Ja=s.selection.rotation,H.element=t,H.display(),(t=document.getElementById("attrBox")).style.visibility="visible",s.valid=!1;else{for(var n=s.ka,i=(i=n.length)-1;0<=i;i--)if(n[i].contains(t,a))return t=n[i],H.element=t,H.display(),U?(s.La=Math.atan2(e.y-t.y,e.x-t.x),s.Ca=!0):(s.ra=e.x-t.x,s.la=e.y-t.y,s.wa=!0),s.selection=t,s.Ja=s.selection.rotation,s.valid=!1,void((t=document.getElementById("attrBox")).style.visibility="visible");s.selection&&(s.selection=null,s.valid=!1)}},!0),t.addEventListener("mousemove",function(t){var a;if(xa||!s.wa&&!s.Ca||(a=N(s,t),R(s),xa=!0),a=N(s,t),s.za)ya=a.x-s.ra,za=a.y-s.la,s.da.setTransform(E,0,0,E,K+ya,za+L),s.valid=!1;else if(s.Fa)0!=t.movementY&&(Ba((a=Ea(s.ra,s.la)).x,a.y,E*(1+.05*(0<t.movementY?1:-1))),s.valid=!1);else if(s.wa)s.selection.x=(a.x-K)/E-s.ra,s.selection.y=(a.y-L)/E-s.la,s.valid=!1;else if(s.Ca)(t=s.selection).rotation=C(s.Ja+Math.atan2((a.y-L)/E-s.selection.y,(a.x-K)/E-s.selection.x)-s.La,2*Math.PI),t.update(),s.valid=!1;else{for(var e=(t=s.ka).length-1;0<=e;e--)if(t[e].contains(a.x,a.y))return void(wa=!0);wa=!1}},!0),t.addEventListener("mouseup",function(t){xa=!1,s.wa=!1,s.Ca=!1,s.Fa?(t=N(s,t),s.Ka+=t.y-s.la,s.Fa=!1):s.za&&(t=N(s,t),K+=t.x-s.ra,L+=t.y-s.la,s.za=!1)},!0),t.addEventListener("wheel",function(t){var a=N(s,t);Ba((a=Ea(a.x,a.y)).x,a.y,E*(1+.1*(t.deltaY<0?1:-1))),p.valid=!1},!0),requestAnimationFrame(this.ja.bind(this))}function Q(t,a){R(t),t.ka.push(a),t.valid=!1}function Ea(t,a){return{x:(t-K)/E,y:(a-L)/E}}function Da(t){var a,e=50*E,i=t.za?(a=C(ya+K+1,e),C(za+L+Aa,e)):(a=C(K+1,e),C(L+Aa,e));t.canvas.style.backgroundSize=e+"px "+e+"px",t.canvas.style.backgroundPositionX=a+"px",t.canvas.style.backgroundPositionY=i+"px"}function N(t,a){var e=t.canvas,i=0,n=0;if(void 0!==e.offsetParent)for(;i+=e.offsetLeft,n+=e.offsetTop,e=e.offsetParent;);return i+=t.Ua+t.Sa+t.Ma,n+=t.Va+t.Ta+t.Na,{x:a.pageX-i,y:a.pageY-n}}function Ca(t){var a=[];a.push(new I(-4e3,-4e3,4e3,-4e3)),a.push(new I(4e3,-4e3,4e3,4e3)),a.push(new I(4e3,4e3,-4e3,4e3)),a.push(new I(-4e3,4e3,-4e3,-4e3)),t.ia=a}function ha(){var t,a=p;W.length&&(t={elements:Fa(a),lightSources:Ga(a)},X.push(t),t=W.pop(),a.ka=t.elements,a.ea=t.lightSources[0],a.selection=null,a.valid=!1)}function ia(){var t,a=p;X.length&&(W.push({elements:Fa(a),lightSources:Ga(a)}),t=X.pop(),a.ka=t.elements,a.ea=t.lightSources[0],a.selection=null,a.valid=!1)}function Fa(t){for(var a=[],e=(t=t.ka).length,i=0;i<e;i++)a.push(t[i].Ea());return a}function Ga(t){var a=[];return(t=t.ea)&&a.push(t.Ea()),a}function R(t){var a=Fa(t),e=Ga(t);X=[],W.push({elements:a,lightSources:e}),t.valid=!1}function I(t,a,e,i){this.aa=t,this.ba=a,this.pa=e,this.qa=i,this.type="line"}function Ha(){}function Y(){this.type="CircularSegment",this.$=new Ha}function Ia(t){t.$.x=t.x+Math.cos(t.rotation)*t.r,t.$.y=t.y+Math.sin(t.rotation)*t.r,t.$.r=Math.abs(t.r);var a=Math.asin(t.va/Math.abs(t.r));t.ha=a,0<t.r?(t.na=t.$.x-Math.cos(a-t.rotation)*t.r,t.oa=t.$.y+Math.sin(a-t.rotation)*t.r,t.ta=t.$.x-Math.cos(0-a-t.rotation)*t.r,t.ua=t.$.y+Math.sin(0-a-t.rotation)*t.r):(t.ta=t.$.x-Math.cos(a-t.rotation)*t.r,t.ua=t.$.y+Math.sin(a-t.rotation)*t.r,t.na=t.$.x-Math.cos(0-a-t.rotation)*t.r,t.oa=t.$.y+Math.sin(0-a-t.rotation)*t.r)}function Element(t,a,e,i){this.x=t,this.y=a,this.rotation=e,this.n=i}function P(t,a,e,i,n,s,o,h,r){Element.apply(this,arguments),this.fa=n,this.ga=s,this.rotation=e,this.Da=h,this.va=o,this.color=r||"#33cccc",this.attributes=["r1","r2","semi_diameter","n","w"],this.ia=[],this.ia.push(new I),this.ia.push(new I),this.l=new Y,this.v=new Y,this.ja(p.da)}function Ja(){this.element=void 0,this.display()}M.prototype.clear=function(){this.da.clearRect(-8e3,-8e3,18e3,18e3)},M.prototype.ja=function(){if(U&&wa?(t=document.getElementsByTagName("body")[0]).style.cursor="url('images/png/cursors/rotate-cursor-hot-pink.png') 15 15, auto":S?(t=document.getElementsByTagName("body")[0]).style.cursor="url('images/png/cursors/scroll-cursor-hot-pink.png') 15 15, auto":T?(t=document.getElementsByTagName("body")[0]).style.cursor="url('images/png/cursors/zoom-plus-cursor-white.png') 15 15, auto":"default"==O&&((t=document.getElementsByTagName("body")[0]).style.cursor="default"),!this.valid){var t=this.da,a=this.ka,e=(this.clear(),Da(this),this.ia);this.da.beginPath(),this.da.strokeStyle="green",this.da.lineWidth=100,this.da.moveTo(e[0].aa,e[0].ba);for(var i=0;i<e.length;i+=1)e[i].ja(this.da);for(this.da.stroke(),e=a.length,i=0;i<e;i++)a[i].ja(t);null!=this.selection?this.selection.Ia(t):document.getElementById("attrBox").style.visibility="hidden",this.ea&&this.Ha(this.ea),this.valid=!0}requestAnimationFrame(this.ja.bind(this))},M.prototype.Ha=function(){return this.ea.Ha(this.ka,this.ia)},M.prototype.load=function(t){var a=[],e=t.elements;t=t.lightSources;for(var i,n=0;n<e.length;n++)i=new P((i=e[n]).x,i.y,i.rotation,i.n,i.r1,i.r2,i.semi_diameter,i.w),a.push(i);for(this.ka=a,n=0;n<t.length;n+=1)a=t[n],this.ea=new G(a.x,a.y,a.h,a.rotation,a.numRays);this.selection=null,this.valid=!1},I.prototype.update=function(t,a,e,i){this.aa=t,this.ba=a,this.pa=e,this.qa=i},I.prototype.Ba=function(t){return!!(t=oa(t.aa,t.ba,t.pa,t.qa,this.aa,this.ba,this.pa,this.qa))&&{x:t.x,y:t.y,curve:this}},I.prototype.sa=function(){return new q(1,Math.atan2(this.pa-this.aa,this.ba-this.qa))},I.prototype.ja=function(t){t.lineTo(this.pa,this.qa)},Y.prototype.update=function(t,a,e,i,n){this.x=t,this.y=a,this.r=e,this.rotation=n,this.va=i,Ia(this)},Y.prototype.sa=function(t,a){return new q(1,Math.atan2(a-this.$.y,t-this.$.x))},Y.prototype.ja=function(t){Ia(this);var a=0,e=(this.r<0&&(a=Math.PI),Math.asin(this.va/Math.abs(this.r)));t.arc(this.$.x,this.$.y,Math.abs(this.r),this.rotation+a+Math.PI-e,this.rotation+Math.PI+e+a)},Element.prototype.Aa=function(t,a){this[t]=a,ua(this),p.valid=!1},(k=P.prototype).update=function(){var t=this.va,a=this.ga,e=this.rotation,i=this.x,n=this.y,s=this.Da,o=this.l,h=this.v,r=i+Math.cos(e)*s/2,l=n+Math.sin(e)*s/2;this.l.update(i-Math.cos(e)*s/2,n-Math.sin(e)*s/2,this.fa,t,e),this.v.update(r,l,a,t,e),this.ia[0].update(o.na,o.oa,h.na,h.oa),this.ia[1].update(h.ta,h.ua,o.ta,o.ua)},k.ja=function(t){this.update(),this.getAttribute("n")<0?t.fillStyle="#996633":0==this.getAttribute("n")?t.fillStyle="#cccccc":t.fillStyle="#33cccc";var a=new Path2D,e=(t.beginPath(),t.lineWidth=1/E,this.l.$.x-Math.cos(this.rotation)*this.fa/Math.sin(Math.PI/2-this.l.ha)),i=this.l.$.y-Math.sin(this.rotation)*this.fa/Math.sin(Math.PI/2-this.l.ha),n=this.v.$.x-Math.cos(this.rotation)*this.ga/Math.sin(Math.PI/2-this.v.ha),s=this.v.$.y-Math.sin(this.rotation)*this.ga/Math.sin(Math.PI/2-this.v.ha);a.moveTo(this.l.na,this.l.oa),a.lineTo(this.v.na,this.v.oa),a.arcTo(n,s,this.v.ta,this.v.ua,Math.abs(this.ga)),a.lineTo(this.l.ta,this.l.ua),a.arcTo(e,i,this.l.na,this.l.oa,Math.abs(this.fa)),t.closePath(),t.fill(a),this.path=a},k.Ia=function(t){this.update();var a=new Path2D,e=(t.beginPath(),t.strokeStyle="#ffcc00",t.lineWidth=2/E,this.l.$.x-Math.cos(this.rotation)*this.fa/Math.sin(Math.PI/2-this.l.ha)),i=this.l.$.y-Math.sin(this.rotation)*this.fa/Math.sin(Math.PI/2-this.l.ha),n=this.v.$.x-Math.cos(this.rotation)*this.ga/Math.sin(Math.PI/2-this.v.ha),s=this.v.$.y-Math.sin(this.rotation)*this.ga/Math.sin(Math.PI/2-this.v.ha);a.moveTo(this.l.na,this.l.oa),a.lineTo(this.v.na,this.v.oa),a.arcTo(n,s,this.v.ta,this.v.ua,Math.abs(this.ga)),a.lineTo(this.l.ta,this.l.ua),a.arcTo(e,i,this.l.na,this.l.oa,Math.abs(this.fa)),t.closePath(),t.stroke(a),this.path=a},k.contains=function(t,a){return p.da.isPointInPath(this.path,t,a)},k.Ea=function(){return new P(this.x,this.y,this.rotation,this.n,this.fa,this.ga,this.va,this.Da,this.color)},k.getAttribute=function(t){return"x"==t?this.x:"y"==t?this.y:"rotation"==t?this.rotation:"r1"==t?this.fa:"r2"==t?this.ga:"semi_diameter"==t?this.va:"n"==t?this.n:"w"==t?this.Da:void 0},k.Aa=function(t,a){"r1"!=t&&"r2"!=t||(a=0<a?Math.min(3e4,a):Math.max(-3e4,a)),"r1"==t?this.fa=a:"r2"==t?this.ga=a:"semi_diameter"==t?this.va=a:"n"==t?this.n=a:"w"==t&&(this.Da=a),p.valid=!1,H.display()},k.Ba=function(t){for(var a,e=[],i=0;i<this.ia.length;i+=1)!(a=(a=this.ia[i]).Ba(t))||D(a.x,t.aa,.1)&&D(a.y,t.ba,.1)||e.push(a);if(e.length){for(var n,s=e[0],o=A(s.x,s.y,t.aa,t.ba),i=0;i<e.length;i+=1)(a=A((n=e[i]).x,n.y,t.aa,t.ba))<o&&(s=n,o=a);s.element=this,e=s}else e=!1;return a=0<this.ga?this.rotation+Math.PI-this.v.ha:this.rotation-this.v.ha,i=ma(t.aa,t.ba,t.pa,t.qa,this.l.$.x,this.l.$.y,Math.abs(this.fa),0<this.fa?this.rotation+Math.PI-this.l.ha:this.rotation-this.l.ha,2*this.l.ha),a=ma(t.aa,t.ba,t.pa,t.qa,this.v.$.x,this.v.$.y,Math.abs(this.ga),a,2*this.v.ha),na(n=[],i),na(n,a),i=1==n.length?{x:n[0][0],y:n[0][1],curve:i.length?this.l:this.v,element:this}:2==n.length&&(i=[n[0][0],n[0][1]],a=[n[1][0],n[1][1]],n=A(i[0],i[1],t.aa,t.ba),s=A(a[0],a[1],t.aa,t.ba),D(i[0],t.aa,.1)&&D(i[1],t.ba,.1)||!(n<s||D(a[0],t.aa,.1)&&D(a[1],t.ba,.1))?{x:a[0],y:a[1],curve:this.v,element:this}:{x:i[0],y:i[1],curve:this.l,element:this}),boxDist=e&&A(e.x,e.y,t.aa,t.ba),arcDist=i&&A(i.x,i.y,t.aa,t.ba),boxDist<.001&&(e=!1),arcDist<.001&&(i=!1),(!1!==e||!1!==i)&&(!1!==e&&(!1===i||boxDist<arcDist)?e:i)},k.sa=function(t,a,e){return t==this.l&&0<this.fa?t.sa(a,e):t==this.l&&this.fa<0||t==this.v&&0<this.ga?ka(t.sa(a,e)):t==this.v&&this.ga<0?t.sa(a,e):"line"==t.type?t.sa():void 0},Ja.prototype.Aa=function(t){var a=t.srcElement.parentNode.parentNode.children[0].innerHTML;t=t.srcElement.value,R(p),this.element.Aa(a,t)},Ja.prototype.display=function(){var t=document.getElementById("attrBox"),a=document.createElement("hello");if(this.element){for(var e,i,n,s=this.element.attributes,o=0;o<s.length;o+=1)key=s[o],-1<s.indexOf(key)&&(i=(e=document.createElement("tr")).insertCell(0),n=e.insertCell(1),i.innerHTML=key,n.innerHTML+='<input type="text" name="fname">',n.children[0].value=this.element.getAttribute(key),n.contentEditable="true",n.children[0].addEventListener("change",this.Aa.bind(this),!1),a.appendChild(e));t.replaceChild(a,t.children[0])}};var H,p,va,J,O="default",T=!1,sa=3,U=!1,S=!1,W=[],X=[],Z={A:"00",B:"000",C:"0000",D:"0.",E:"1.",F:"2.",G:"3.",H:"4.",I:"5.",J:"6.",K:"7.",L:"8.",M:"9.",N:"0,",O:"1,",P:"2,",Q:"3,",R:"4,",S:"5,",T:"6,",U:"7,",V:"8,",W:"9,",X:"0;",Y:"1;",Z:"2;",a:"3;",b:"4;",c:"5;",d:"6;",f:"7;",g:"8;",h:"9;",i:",0",j:",1",k:",2",m:",3",n:",4",o:",5",p:",6",q:",7",r:",8",s:",9",t:";0",u:";1",w:";2",x:";3",y:";4",z:","},Z=[["A","00"],["B","000"],["C","0000"],["D","0."],["E","1."],["F","2."],["G","3."],["H","4."],["I","5."],["J","6."],["K","7."],["L","8."],["M","9."],["N","0,"],["O","1,"],["P","2,"],["Q","3,"],["R","4,"],["S","5,"],["T","6,"],["U","7,"],["V","8,"],["W","9,"],["X","0;"],["Y","1;"],["Z","2;"],["a","3;"],["b","4;"],["c","5;"],["d","6;"],["f","7;"],["g","8;"],["h","9;"],["i",",0"],["j",",1"],["k",",2"],["m",",3"],["n",",4"],["o",",5"],["p",",6"],["q",",7"],["r",",8"],["s",",9"],["t",";0"],["u",";1"],["w",";2"],["x",";3"],["y",";4"],["z",","]];function ea(){var t=p,a={},e=t.ka;a.elements=[];for(var i,n=0;n<e.length;n++)i=t.ka[n],tmp={type:"lens",x:i.getAttribute("x"),y:i.getAttribute("y"),rotation:i.getAttribute("rotation"),r1:i.getAttribute("r1"),r2:i.getAttribute("r2"),semi_diameter:i.getAttribute("semi_diameter"),n:i.getAttribute("n"),w:i.getAttribute("w")},a.elements.push(tmp);for(t.ea?(t=t.ea,a.lightSources=[{type:"light",x:t.x,y:t.y,rotation:t.rotation,numRays:t.ya,h:t.xa}]):a.lightSources=[],saveData=a,compressedSaveData="0.1~",a=0;a<saveData.elements.length;a+=1)t=saveData.elements[a],compressedSaveData=(compressedSaveData=(compressedSaveData=(compressedSaveData=(compressedSaveData=(compressedSaveData=(compressedSaveData=(compressedSaveData+=t.x+",")+(t.y+","))+(t.rotation+","))+(t.r1+","))+(t.r2+","))+(t.n+","))+(t.semi_diameter+","))+t.w,a!=saveData.elements.length-1&&(compressedSaveData+="_");for(compressedSaveData+="~",a=0;a<saveData.lightSources.length;a+=1)t=saveData.lightSources[a],compressedSaveData=(compressedSaveData=(compressedSaveData=(compressedSaveData=(compressedSaveData+=t.x+",")+(t.y+","))+(t.rotation+","))+(t.h+","))+t.numRays,a!=saveData.lightSources.length-1&&(compressedSaveData+="_");for(a=0;a<Z.length;a+=1)t=Z[a],compressedSaveData=compressedSaveData.replaceAll(t[1].toString(),t[0]);return compressedSaveData}function ga(t){var a=t;for(t=Z.length-1;0<=t;--t)e=Z[t],a=a.replaceAll(e[0].toString(),e[1]);var a=(t=a.split("~"))[2],e={version:t[0],elements:[],lightSources:[]},i=t[1].split("_");for(t=0;t<i.length;t+=1){var n=i[t].split(","),n={type:"lens",x:parseInt(n[0]),y:parseInt(n[1]),rotation:parseFloat(n[2]),r1:parseFloat(n[3]),r2:parseFloat(n[4]),n:parseFloat(n[5]),semi_diameter:parseFloat(n[6]),w:parseFloat(n[7])};e.elements.push(n)}for(a=a.split("_"),t=0;t<a.length;t+=1)n=a[t].split(","),n={type:"lightSource",x:parseInt(n[0]),y:parseInt(n[1]),rotation:parseFloat(n[2]),h:parseFloat(n[3]),numRays:parseInt(n[4])},e.lightSources.push(n);return e}function Ka(){var t=document.getElementsByTagName("body")[0];document.getElementById("plano-convex").onclick=function(){t.style.cursor="url('images/png/plano-convex.png') 50 50, auto",O="planoconvex"},document.getElementById("plano-concave").onclick=function(){t.style.cursor="url('images/png/plano-concave.png') 50 50, auto",O="planoconcave"},document.getElementById("medium").onclick=function(){t.style.cursor="url('images/png/medium.png') 50 50, auto",O="medium"},document.getElementById("lightSource").onclick=function(){t.style.cursor="url('images/png/lightSource.png') 50 50, auto",O="lightSource"},document.getElementById("mirror").onclick=function(){t.style.cursor="url('images/png/mirror.png') 50 50, auto",O="mirror"},document.getElementById("wall").onclick=function(){t.style.cursor="url('images/png/wall.png') 50 50, auto",O="wall"}}function La(){document.addEventListener("keydown",function(t){if(t.shiftKey)U=!0;else{if(" "==t.key||"t"==t.key)return!(S=!0);if(77==t.keyCode)T=!0;else if(46!=t.keyCode&&8!=t.keyCode||"text"==t.target.type)90==t.keyCode&&t.ctrlKey?ha():89==t.keyCode&&t.ctrlKey&&ia();else{var a=(t=p).selection;if(R(t),a==t.ea)t.ea=null;else for(var e=t.ka,i=e.length,n=0;n<i;n+=1)e[n]==a&&e.splice(n,1);t.selection=null,t.wa=!1,t.valid=!1}}},!0),window.addEventListener("keyup",function(t){U&&!t.shiftKey?U=!1:!S||32!=t.keyCode&&"t"!=t.key?T&&77==t.keyCode&&(T=!1):S=!1},!0),window.addEventListener("resize",function(){p.canvas.width=window.innerWidth-10,p.canvas.height=window.innerHeight-82,p.width=p.canvas.width,p.height=p.canvas.height,p.valid=!1},!0)}function Ma(){(va=new Image).src="images/png/flashlight.png",(J=new Image).src="images/png/highlighted_flashlight.png",J.onload=function(){var t;fa(),Ka(),(ctx=document.getElementById("myCanvas").getContext("2d")).canvas.width=window.innerWidth-10,ctx.canvas.height=window.innerHeight-60,p=new M(document.getElementById("myCanvas")),H=new Ja,(queryParams=new URLSearchParams(window.location.search)).has("cs")&&(t=ga(queryParams.get("cs")),p.load(t)),La()}}document.addEventListener("DOMContentLoaded",function(){Ma()},!1);
